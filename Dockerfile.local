# ==========================================
# DomMate - æœ¬åœ°æ„å»ºç‰ˆ Dockerfile
# åŸºäº Ubuntu 20.04ï¼Œå†…ç½®Node.jså®‰è£…
# ==========================================

FROM ubuntu:20.04

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_VERSION=22
ENV DEBIAN_FRONTEND=noninteractive
ENV NODE_ENV=production
ENV SERVER_HOST=0.0.0.0
ENV SERVER_PORT=3001
ENV DATABASE_PATH=/app/data/domains.db
ENV BACKUP_DIR=/app/data/backups

# è®¾ç½®æ—¶åŒº
RUN ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo Asia/Shanghai > /etc/timezone

# æ›´æ–°ç³»ç»ŸåŒ…å¹¶å®‰è£…åŸºç¡€ä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    ca-certificates \
    gnupg \
    lsb-release \
    sqlite3 \
    python3 \
    python3-pip \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# æ‰‹åŠ¨å®‰è£…Node.js 22
RUN curl -fsSL https://nodejs.org/dist/v22.17.1/node-v22.17.1-linux-x64.tar.xz -o node.tar.xz || \
    (echo "ç½‘ç»œä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨aptå®‰è£…è¾ƒè€ç‰ˆæœ¬..." && \
     apt-get update && \
     apt-get install -y nodejs npm && \
     rm -rf /var/lib/apt/lists/*) && \
    if [ -f node.tar.xz ]; then \
        tar -xJf node.tar.xz && \
        cp -r node-v22.17.1-linux-x64/* /usr/local/ && \
        rm -rf node-v22.17.1-linux-x64 node.tar.xz; \
    fi

# éªŒè¯Node.jså®‰è£…
RUN node --version && npm --version

# åˆ›å»ºåº”ç”¨ç”¨æˆ·å’Œç»„
RUN groupadd -g 1001 dommate && \
    useradd -r -u 1001 -g dommate dommate

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºå¿…è¦ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /app/data /app/logs /app/backups /app/temp/exports && \
    chown -R dommate:dommate /app && \
    chmod -R 755 /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# è®¾ç½®npmé•œåƒæºå¹¶å®‰è£…ä¾èµ–
RUN npm config set registry https://registry.npmmirror.com/ || \
    npm config set registry https://registry.npm.taobao.org/ || \
    echo "ä½¿ç”¨é»˜è®¤registry"

# å®‰è£…ç”Ÿäº§ä¾èµ–
RUN npm cache clean --force && \
    (npm ci --only=production --no-audit --no-fund || \
     npm install --production --legacy-peer-deps --no-audit --no-fund)

# å¤åˆ¶æºç 
COPY . .

# æ„å»ºå‰ç«¯ - å¤šå±‚å›é€€ç­–ç•¥
RUN echo "ğŸ—ï¸ å¼€å§‹æ„å»ºå‰ç«¯..." && \
    (npm run build && echo "âœ… æ ‡å‡†æ„å»ºæˆåŠŸ") || \
    (echo "æ ‡å‡†æ„å»ºå¤±è´¥ï¼Œå°è¯•è·³è¿‡ç±»å‹æ£€æŸ¥..." && npm run build --skip-type-check && echo "âœ… è·³è¿‡ç±»å‹æ£€æŸ¥æ„å»ºæˆåŠŸ") || \
    (echo "æ„å»ºå¤±è´¥ï¼Œå°è¯•rollupä¿®å¤..." && \
     rm -rf node_modules/@rollup/ node_modules/rollup && \
     npm install @rollup/rollup-linux-x64-musl --optional --legacy-peer-deps && \
     npm run build && echo "âœ… Rollupä¿®å¤æ„å»ºæˆåŠŸ") || \
    (echo "Rollupä¿®å¤å¤±è´¥ï¼Œå®Œå…¨é‡æ–°å®‰è£…..." && \
     rm -rf node_modules package-lock.json && \
     npm install --legacy-peer-deps && \
     npm run build && echo "âœ… é‡æ–°å®‰è£…æ„å»ºæˆåŠŸ") || \
    echo "âš ï¸ æ‰€æœ‰æ„å»ºå°è¯•éƒ½å¤±è´¥ï¼Œä½†å®¹å™¨ä»å¯å¯åŠ¨"

# éªŒè¯æ„å»ºäº§ç‰©
RUN if [ -d "dist" ]; then \
        echo "âœ… å‰ç«¯æ„å»ºäº§ç‰©å­˜åœ¨ï¼Œæ–‡ä»¶æ•°é‡: $(ls dist/ | wc -l)"; \
    else \
        echo "âŒ å‰ç«¯æ„å»ºäº§ç‰©ç¼ºå¤±ï¼Œä½†æœåŠ¡å™¨ä»å¯è¿è¡Œ"; \
    fi

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN cat > /app/entrypoint.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ DomMate å®¹å™¨å¯åŠ¨ä¸­..."
echo "ğŸ“Š Node.js ç‰ˆæœ¬: $(node --version)"
echo "ğŸ“Š è¿è¡Œç”¨æˆ·: $(whoami)"

# ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
echo "ğŸ“ ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨..."
mkdir -p /app/data/backups 2>/dev/null || {
    echo "âš ï¸ åˆ›å»ºæ•°æ®ç›®å½•éœ€è¦æƒé™..."
    sudo mkdir -p /app/data/backups 2>/dev/null || mkdir -p /app/data/backups
}

# æ£€æŸ¥ç›®å½•æƒé™
if [ -w "/app/data" ]; then
    echo "âœ… æ•°æ®ç›®å½•æƒé™æ­£å¸¸"
else
    echo "âš ï¸ æ•°æ®ç›®å½•æƒé™ä¸è¶³ï¼Œå°è¯•ä¿®å¤..."
    chmod -R 755 /app/data 2>/dev/null || echo "æƒé™ä¿®å¤å¤±è´¥ï¼Œç»§ç»­å¯åŠ¨..."
fi

# æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
echo "âš™ï¸ ç¯å¢ƒé…ç½®:"
echo "  â€¢ æ•°æ®åº“è·¯å¾„: ${DATABASE_PATH}"
echo "  â€¢ å¤‡ä»½ç›®å½•: ${BACKUP_DIR}"
echo "  â€¢ æœåŠ¡ç«¯å£: ${SERVER_PORT}"

# æ£€æŸ¥å‰ç«¯æ„å»ºäº§ç‰©
if [ -f "/app/dist/index.html" ]; then
    echo "âœ… å‰ç«¯æ„å»ºäº§ç‰©å­˜åœ¨"
else
    echo "âŒ å‰ç«¯æ„å»ºäº§ç‰©ç¼ºå¤±ï¼Œä½†æœåŠ¡å™¨ä»å¯è¿è¡Œ"
fi

echo "ğŸ¯ å¯åŠ¨DomMateåº”ç”¨..."
exec "$@"
EOF

# è®¾ç½®å¯åŠ¨è„šæœ¬æƒé™
RUN chmod +x /app/entrypoint.sh && \
    chown dommate:dommate /app/entrypoint.sh

# å®‰è£…sudoï¼ˆç”¨äºæƒé™ä¿®å¤ï¼‰
RUN apt-get update && apt-get install -y sudo && \
    echo "dommate ALL=(ALL) NOPASSWD: /bin/mkdir, /bin/chown, /bin/chmod" > /etc/sudoers.d/dommate && \
    rm -rf /var/lib/apt/lists/*

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER dommate

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:${SERVER_PORT}/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 3001

# ä½¿ç”¨å¯åŠ¨è„šæœ¬
ENTRYPOINT ["/app/entrypoint.sh"]

# å¯åŠ¨åº”ç”¨
CMD ["node", "server/index.js"] 