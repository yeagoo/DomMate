# 🔐 强制密码修改功能说明

## 📋 功能概述

域名监控平台现已支持**强制密码修改**功能，管理员可以根据安全需求强制用户在登录后修改密码。

## ✨ 主要特性

### 🔒 安全保护
- **首次登录强制修改**: 默认密码用户必须修改密码
- **密码过期检测**: 支持设置密码过期天数（可配置）
- **管理员强制**: 管理员可随时要求用户修改密码
- **无法绕过**: 在修改密码前无法访问系统功能

### 🎯 用户体验
- **美观界面**: 现代化的密码修改对话框
- **清晰提示**: 显示强制修改的具体原因
- **实时验证**: 密码强度和一致性检查
- **双语支持**: 中英文界面切换

## 🚀 使用方式

### 管理员操作

#### 1. 密码管理工具
```bash
./password-admin-tool.sh
```

**主要功能：**
- 查看当前密码策略
- 强制用户修改密码
- 重置为默认密码
- 查看系统状态

#### 2. API操作
```bash
# 设置强制修改密码
curl -X POST "http://localhost:3001/api/auth/force-password-change" \
  -H "Content-Type: application/json" \
  -H "X-Session-Id: YOUR_SESSION_ID" \
  -d '{"reason": "安全策略要求"}'

# 查看强制修改状态
curl "http://localhost:3001/api/auth/force-password-change"
```

### 用户体验流程

#### 正常登录流程
1. 输入用户名密码
2. 系统验证身份
3. 直接进入系统

#### 强制修改密码流程
1. 输入用户名密码
2. 系统验证身份成功
3. **显示强制修改密码对话框**
4. 用户输入当前密码和新密码
5. 密码修改成功后进入系统

## 🛠️ 技术实现

### 数据库配置
```sql
-- 强制修改密码标记
force_password_change: 'true'|'false'

-- 强制修改原因
force_change_reason: '原因描述'

-- 密码创建时间
password_created_at: ISO时间戳

-- 密码过期天数（0=不过期）
password_expire_days: 数字
```

### API端点

| 端点 | 方法 | 功能 | 认证 |
|------|------|------|------|
| `/api/auth/login` | POST | 登录（返回强制修改状态） | ❌ |
| `/api/auth/force-password-change` | GET | 查看强制修改状态 | ❌ |
| `/api/auth/force-password-change` | POST | 设置强制修改密码 | ✅ |
| `/api/auth/change-password` | POST | 修改密码 | ✅ |

### 前端组件
- `LoginForm.tsx` - 支持强制修改密码响应
- `ForcedPasswordChangeDialog.tsx` - 强制修改密码对话框
- `AuthenticatedApp.tsx` - 认证流程控制

## 📝 配置示例

### 设置密码过期（90天）
```javascript
// 数据库配置
await db.setAuthConfig('password_expire_days', '90');
```

### 强制所有用户修改密码
```bash
# 使用管理工具
./password-admin-tool.sh
# 选择选项 3: 强制用户修改密码
```

### 清除强制修改标记
```javascript
// 通过API（密码修改成功后自动执行）
await db.clearForcePasswordChange();
```

## 🔧 故障排除

### 常见问题

**Q: 用户忘记当前密码怎么办？**
A: 使用管理工具重置为默认密码，然后要求用户修改。

**Q: 如何批量要求所有用户修改密码？**
A: 通过管理工具设置强制修改，所有用户下次登录时都会被要求修改。

**Q: 密码修改后仍提示强制修改？**
A: 检查数据库中的`force_password_change`配置是否被正确清除。

### 调试命令
```bash
# 测试强制修改功能
./test-force-password-change.sh

# 查看系统状态
./password-admin-tool.sh
# 选择选项 6: 查看系统状态
```

## 🎯 最佳实践

### 安全建议
1. **首次部署**: 立即修改默认密码 `admin123`
2. **定期检查**: 建议每季度检查密码策略
3. **应急响应**: 安全事件后立即要求所有用户修改密码
4. **密码策略**: 要求至少6位字符，建议包含数字和字母

### 用户教育
1. 解释强制修改的安全意义
2. 提供密码强度建议
3. 建议使用密码管理器
4. 定期更新安全意识

## 📊 监控指标

### 可监控的数据
- 强制修改密码的触发次数
- 用户密码修改完成率
- 平均密码修改时间
- 登录失败次数（密码相关）

### 日志记录
系统会自动记录：
- 强制修改密码的设置
- 密码修改成功/失败
- 强制修改标记的清除

---

## 🆘 技术支持

如需技术支持或有任何问题，请检查：
1. 服务器日志：查看 `node server/index.js` 输出
2. 数据库状态：检查认证相关表
3. API测试：使用提供的测试脚本

**系统地址：**
- 管理界面：http://localhost:4322/
- API地址：http://localhost:3001/api

---

*该功能确保您的域名监控平台具有企业级的安全保护能力！* 🛡️ 