# ğŸ”§ æ•°æ®æŒä¹…åŒ–é…ç½®ä¿®å¤

## ğŸ¯ é—®é¢˜è¯Šæ–­

**ç”¨æˆ·æŠ¥å‘Šç¬¬åäºŒé˜¶æ®µé—®é¢˜**:
```
ç°åœ¨æŒ‚è½½äº† /app/dataï¼Œä½†æ˜¯å®¹å™¨æ¯æ¬¡é‡å¯æ•°æ®å°±ä¼šä¸¢å¤±ã€‚
```

**é—®é¢˜åˆ†æ**: è™½ç„¶Docker volumeå·²æ­£ç¡®æŒ‚è½½åˆ°`/app/data`ï¼Œä½†æ•°æ®åº“æ–‡ä»¶å­˜å‚¨åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼Œå¯¼è‡´æ•°æ®æ— æ³•æŒä¹…åŒ–ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› 

### **æ•°æ®åº“æ–‡ä»¶è·¯å¾„é…ç½®é—®é¢˜**
- **VolumeæŒ‚è½½**: `/app/data` ç›®å½•å·²æ­£ç¡®æŒ‚è½½åˆ°å®¿ä¸»æœº âœ…
- **æ•°æ®åº“è·¯å¾„**: å®é™…å­˜å‚¨åœ¨é¡¹ç›®æ ¹ç›®å½• `./domains.db` âŒ
- **æŒä¹…åŒ–å¤±æ•ˆ**: æ•°æ®åº“æ–‡ä»¶ä¸åœ¨æŒ‚è½½ç›®å½•ä¸­ï¼Œé‡å¯åä¸¢å¤± âŒ

### **é…ç½®åˆ†æ**:

**åŸå§‹é…ç½®** âŒ (`server/database.js`):
```javascript
// æ•°æ®åº“æ–‡ä»¶è·¯å¾„
const DB_PATH = join(__dirname, '..', 'domains.db');
// å®é™…è·¯å¾„: /app/domains.db (ä¸åœ¨æŒ‚è½½ç›®å½•ä¸­)
```

**Docker Volume æŒ‚è½½**:
```bash
# ç”¨æˆ·çš„æŒ‚è½½é…ç½®
-v dommate-data:/app/data
# æŒ‚è½½ç‚¹: /app/data (æ­£ç¡®)
# æ•°æ®åº“æ–‡ä»¶: /app/domains.db (ä¸åœ¨æŒ‚è½½ç›®å½•ä¸­)
```

### **é—®é¢˜è¡¨ç°**:
- âœ… **å®¹å™¨å¯åŠ¨**: æ•°æ®åº“åˆ›å»ºå’Œåˆå§‹åŒ–æ­£å¸¸
- âœ… **æ•°æ®æ“ä½œ**: åŸŸåæ·»åŠ ã€é‚®ä»¶é…ç½®ç­‰åŠŸèƒ½æ­£å¸¸
- âŒ **æ•°æ®æŒä¹…åŒ–**: å®¹å™¨é‡å¯åæ‰€æœ‰æ•°æ®ä¸¢å¤±
- âŒ **Volumeæ— æ•ˆ**: æŒ‚è½½çš„ `/app/data` ç›®å½•ä¸ºç©º

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### **ç¬¬ä¸€æ­¥**: ä¿®æ”¹æ•°æ®åº“æ–‡ä»¶è·¯å¾„

**ä¿®å¤å‰** âŒ (`server/database.js`):
```javascript
// æ•°æ®åº“æ–‡ä»¶è·¯å¾„
const DB_PATH = join(__dirname, '..', 'domains.db');
```

**ä¿®å¤å** âœ…:
```javascript
// æ•°æ®åº“æ–‡ä»¶è·¯å¾„ - å­˜å‚¨åœ¨ /app/data ç›®å½•ä»¥å®ç°æ•°æ®æŒä¹…åŒ–
const DB_PATH = process.env.DATABASE_PATH || join(__dirname, '..', 'data', 'domains.db');
```

### **ç¬¬äºŒæ­¥**: æ·»åŠ ç›®å½•åˆ›å»ºé€»è¾‘

**ä¿®å¤å‰** âŒ:
```javascript
// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
async init() {
  return new Promise((resolve, reject) => {
    this.db = new sqlite3.Database(DB_PATH, (err) => {
```

**ä¿®å¤å** âœ…:
```javascript
// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
async init() {
  return new Promise((resolve, reject) => {
    // ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
    const dataDir = dirname(DB_PATH);
    if (!existsSync(dataDir)) {
      try {
        mkdirSync(dataDir, { recursive: true });
        console.log(`âœ… æ•°æ®ç›®å½•åˆ›å»ºæˆåŠŸ: ${dataDir}`);
      } catch (err) {
        console.error(`âŒ æ•°æ®ç›®å½•åˆ›å»ºå¤±è´¥: ${err.message}`);
        reject(err);
        return;
      }
    }

    this.db = new sqlite3.Database(DB_PATH, (err) => {
```

### **ç¬¬ä¸‰æ­¥**: æ›´æ–°ç¯å¢ƒå˜é‡é…ç½®

**ä¿®å¤å‰** âŒ (`env.example`):
```bash
# SQLite database file path (relative to project root)
DATABASE_PATH=./domains.db
```

**ä¿®å¤å** âœ…:
```bash
# SQLite database file path (for Docker containers, use /app/data for persistence)
DATABASE_PATH=/app/data/domains.db

# Database backup directory (ensure this is also in a persistent location)
BACKUP_DIR=/app/data/backups
```

### **ç¬¬å››æ­¥**: åœ¨Dockerfileä¸­è®¾ç½®ç¯å¢ƒå˜é‡

**ä¿®å¤å‰** âŒ:
```dockerfile
# Switch to non-root user
USER dommate
```

**ä¿®å¤å** âœ…:
```dockerfile
# Set environment variables for data persistence
ENV DATABASE_PATH=/app/data/domains.db
ENV BACKUP_DIR=/app/data/backups

# Switch to non-root user
USER dommate
```

---

## âœ… ä¿®å¤æ•ˆæœéªŒè¯

### **æ•°æ®æŒä¹…åŒ–è·¯å¾„**:

| ç»„ä»¶ | ä¿®å¤å‰è·¯å¾„ | ä¿®å¤åè·¯å¾„ | æŒä¹…åŒ–çŠ¶æ€ |
|------|------------|------------|------------|
| **æ•°æ®åº“æ–‡ä»¶** | `/app/domains.db` | `/app/data/domains.db` | âœ… æŒä¹…åŒ– |
| **å¤‡ä»½ç›®å½•** | `/app/backups` | `/app/data/backups` | âœ… æŒä¹…åŒ– |
| **æ—¥å¿—æ–‡ä»¶** | `/app/logs` | `/app/logs` | âŒ éœ€è¦æ‰‹åŠ¨æŒ‚è½½ |
| **ä¸´æ—¶æ–‡ä»¶** | `/app/temp` | `/app/temp` | âŒ é‡å¯æ¸…é™¤ |

### **å®¹å™¨é‡å¯æµ‹è¯•**:
```bash
# 1. å¯åŠ¨å®¹å™¨å¹¶æ·»åŠ æµ‹è¯•æ•°æ®
docker run -d --name dommate-test -p 3001:3001 -v dommate-data:/app/data dommate:latest

# 2. æ·»åŠ åŸŸåã€é…ç½®é‚®ä»¶ç­‰æ“ä½œ
# è®¿é—® http://localhost:3001ï¼Œè¿›è¡Œæ•°æ®æ“ä½œ

# 3. é‡å¯å®¹å™¨
docker restart dommate-test

# 4. éªŒè¯æ•°æ®æŒä¹…åŒ–
# è®¿é—® http://localhost:3001ï¼Œç¡®è®¤æ•°æ®ä»ç„¶å­˜åœ¨ âœ…
```

### **æ–‡ä»¶ç³»ç»Ÿç»“æ„**:
```
å®¹å™¨å†…æ–‡ä»¶ç»“æ„:
/app/
â”œâ”€â”€ data/                    # âœ… Docker Volume æŒ‚è½½ç‚¹
â”‚   â”œâ”€â”€ domains.db          # âœ… æ•°æ®åº“æ–‡ä»¶ (æŒä¹…åŒ–)
â”‚   â””â”€â”€ backups/            # âœ… å¤‡ä»½ç›®å½• (æŒä¹…åŒ–)
â”œâ”€â”€ server/                 # åº”ç”¨ä»£ç 
â”œâ”€â”€ dist/                   # å‰ç«¯æ„å»ºäº§ç‰©
â””â”€â”€ logs/                   # âš ï¸ æ—¥å¿—æ–‡ä»¶ (éæŒä¹…åŒ–)

å®¿ä¸»æœº Docker Volume:
dommate-data/               # Docker Volume
â”œâ”€â”€ domains.db             # âœ… æŒä¹…åŒ–å­˜å‚¨
â””â”€â”€ backups/               # âœ… æŒä¹…åŒ–å­˜å‚¨
```

---

## ğŸ“Š æŒä¹…åŒ–ç­–ç•¥åˆ†æ

### **æ•°æ®åˆ†ç±»**:

**å¿…é¡»æŒä¹…åŒ–** ğŸ”´:
- âœ… æ•°æ®åº“æ–‡ä»¶ (`domains.db`)
- âœ… æ•°æ®åº“å¤‡ä»½ (`backups/`)
- âœ… ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
- âœ… SSLè¯ä¹¦æ–‡ä»¶

**å¯é€‰æŒä¹…åŒ–** ğŸŸ¡:
- âš ï¸ åº”ç”¨æ—¥å¿— (`logs/`)
- âš ï¸ ä¸´æ—¶å¯¼å‡ºæ–‡ä»¶ (`temp/exports/`)
- âš ï¸ ç¼“å­˜æ–‡ä»¶

**ä¸éœ€æŒä¹…åŒ–** ğŸŸ¢:
- âœ… åº”ç”¨ä»£ç  (å®¹å™¨é‡å»º)
- âœ… å‰ç«¯æ„å»ºäº§ç‰© (å®¹å™¨é‡å»º)
- âœ… Node.js modules (å®¹å™¨é‡å»º)

### **æœ€ä½³å®è·µé…ç½®**:
```yaml
# docker-compose.yml - æ¨èé…ç½®
services:
  dommate:
    image: ghcr.io/yeagoo/dommate:latest
    volumes:
      # å¿…éœ€: æ•°æ®æŒä¹…åŒ–
      - dommate-data:/app/data
      # å¯é€‰: æ—¥å¿—æŒä¹…åŒ–
      - dommate-logs:/app/logs
      # å¯é€‰: SSLè¯ä¹¦æŒä¹…åŒ–
      - dommate-ssl:/app/ssl
    environment:
      - DATABASE_PATH=/app/data/domains.db
      - BACKUP_DIR=/app/data/backups

volumes:
  dommate-data:
  dommate-logs:
  dommate-ssl:
```

---

## ğŸ”® é¢„é˜²æªæ–½

### **å¼€å‘ç¯å¢ƒéªŒè¯**:
```bash
# æœ¬åœ°æµ‹è¯•æŒä¹…åŒ–é…ç½®
mkdir -p ./data
export DATABASE_PATH=./data/domains.db
node server/index.js

# éªŒè¯æ•°æ®åº“æ–‡ä»¶åˆ›å»º
ls -la ./data/
# åº”æ˜¾ç¤º: domains.db
```

### **Dockeræ„å»ºéªŒè¯**:
```bash
# æ„å»ºé•œåƒ
docker build -t dommate:test .

# å¯åŠ¨å®¹å™¨
docker run -d --name dommate-test -v test-data:/app/data dommate:test

# æ£€æŸ¥å®¹å™¨å†…è·¯å¾„
docker exec dommate-test ls -la /app/data/
# åº”æ˜¾ç¤º: domains.db

# æ£€æŸ¥VolumeæŒ‚è½½
docker volume inspect test-data
```

### **è‡ªåŠ¨åŒ–æ£€æŸ¥è„šæœ¬**:
```bash
#!/bin/bash
# check-persistence.sh
echo "ğŸ” æ£€æŸ¥æ•°æ®æŒä¹…åŒ–é…ç½®..."

# æ£€æŸ¥ç¯å¢ƒå˜é‡
if [[ "$DATABASE_PATH" == *"/app/data/"* ]]; then
    echo "âœ… æ•°æ®åº“è·¯å¾„é…ç½®æ­£ç¡®: $DATABASE_PATH"
else
    echo "âŒ æ•°æ®åº“è·¯å¾„é…ç½®é”™è¯¯: $DATABASE_PATH"
    exit 1
fi

# æ£€æŸ¥æ•°æ®ç›®å½•
if [ -d "/app/data" ]; then
    echo "âœ… æ•°æ®ç›®å½•å­˜åœ¨: /app/data"
else
    echo "âŒ æ•°æ®ç›®å½•ä¸å­˜åœ¨: /app/data"
    exit 1
fi

echo "âœ… æ•°æ®æŒä¹…åŒ–é…ç½®éªŒè¯é€šè¿‡"
```

---

## ğŸŠ **ä¿®å¤å®Œæˆï¼**

**ç¬¬åäºŒé˜¶æ®µæ•°æ®æŒä¹…åŒ–é…ç½®é—®é¢˜å·²è§£å†³ï¼**

### **æ ¸å¿ƒæ”¹è¿›**:
- âœ… **æ­£ç¡®è·¯å¾„**: æ•°æ®åº“æ–‡ä»¶ç°åœ¨å­˜å‚¨åœ¨ `/app/data` ç›®å½•
- âœ… **è‡ªåŠ¨åˆ›å»º**: å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºå¿…è¦çš„æ•°æ®ç›®å½•
- âœ… **ç¯å¢ƒé…ç½®**: é€šè¿‡ç¯å¢ƒå˜é‡çµæ´»é…ç½®æ•°æ®åº“è·¯å¾„
- âœ… **å®¹å™¨å…¼å®¹**: Dockerç¯å¢ƒä¸‹æ•°æ®å®Œå…¨æŒä¹…åŒ–

### **ç”¨æˆ·ä½“éªŒæå‡**:
- ğŸ’¾ **æ•°æ®å®‰å…¨**: å®¹å™¨é‡å¯ã€æ›´æ–°åæ•°æ®ä¸ä¸¢å¤±
- ğŸ”„ **æ— ç¼å‡çº§**: å‡çº§åº”ç”¨ç‰ˆæœ¬æ—¶ä¿ç•™æ‰€æœ‰æ•°æ®
- ğŸ“Š **å†å²è®°å½•**: åŸŸåç›‘æ§å†å²ã€é‚®ä»¶æ—¥å¿—å®Œæ•´ä¿ç•™
- âš™ï¸ **é…ç½®ä¿æŒ**: SMTPé…ç½®ã€é‚®ä»¶æ¨¡æ¿ã€é€šçŸ¥è§„åˆ™æŒä¹…åŒ–

### **ç«‹å³éªŒè¯**:
```bash
git add -A
git commit -m "ğŸ”§ ç¬¬åäºŒé˜¶æ®µä¿®å¤ï¼šæ•°æ®æŒä¹…åŒ–é…ç½®é—®é¢˜"
git push origin main
```

---

## ğŸ“ ç›¸å…³èµ„æº

- ğŸ“– [Docker Volumeæœ€ä½³å®è·µ](https://docs.docker.com/storage/volumes/)
- ğŸ—„ï¸ [SQLiteæ–‡ä»¶ä½ç½®é…ç½®](https://www.sqlite.org/tempfiles.html)
- ğŸ³ [å®¹å™¨åŒ–åº”ç”¨æ•°æ®ç®¡ç†](https://docs.docker.com/storage/)

**DomMate ç°åœ¨æ‹¥æœ‰å®Œæ•´çš„æ•°æ®æŒä¹…åŒ–è§£å†³æ–¹æ¡ˆï¼** ğŸš€âœ¨

---

## ğŸ¯ **ç¬¬åäºŒé˜¶æ®µä¿®å¤æ€»ç»“**

è¿™æ˜¯ç»§å‰åä¸€é˜¶æ®µä¿®å¤ä¹‹åçš„**ç¬¬åäºŒé˜¶æ®µ**ä¿®å¤ï¼Œè§£å†³äº†Dockerå®¹å™¨æ•°æ®æŒä¹…åŒ–é…ç½®é—®é¢˜ã€‚

**ä¿®å¤è·¯å¾„**: é—®é¢˜è¯Šæ–­ â†’ è·¯å¾„åˆ†æ â†’ æ•°æ®åº“é…ç½®ä¿®å¤ â†’ ç¯å¢ƒå˜é‡æ›´æ–° â†’ ç›®å½•åˆ›å»ºé€»è¾‘ â†’ æŒä¹…åŒ–éªŒè¯

**DomMate é¡¹ç›®ç°åœ¨æ‹¥æœ‰çœŸæ­£çš„ä¼ä¸šçº§æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆï¼** ğŸ‰

---

## ğŸš€ **å®Œæ•´åäºŒé˜¶æ®µä¿®å¤å†ç¨‹**

1. **âœ… é˜¶æ®µ1-6**: GitHub Actions CI/CD æ„å»ºé—®é¢˜
2. **âœ… é˜¶æ®µ7**: Express é™æ€æ–‡ä»¶æœåŠ¡
3. **âœ… é˜¶æ®µ8**: Astro é™æ€è¾“å‡ºæ¨¡å¼  
4. **âœ… é˜¶æ®µ9**: API åŠ¨æ€ URL é…ç½®
5. **âœ… é˜¶æ®µ10**: é‚®ä»¶æ¨¡å— API é…ç½®
6. **âœ… é˜¶æ®µ11**: é‚®ä»¶ API è®¤è¯é›†æˆ
7. **âœ… é˜¶æ®µ12**: æ•°æ®æŒä¹…åŒ–é…ç½® â† **åˆšåˆšå®Œæˆ**

**ä»æ„å»ºåˆ°éƒ¨ç½²åˆ°å‰ç«¯åˆ°APIåˆ°è®¤è¯åˆ°æ•°æ®æŒä¹…åŒ–çš„å®Œæ•´ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆç°å·²å®ç°ï¼** ğŸŒŸ 