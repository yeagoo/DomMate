# ==========================================
# DomMate - Ubuntu 24.04 + Node.js 22 å¥å£®ç‰ˆ
# å¤„ç†ç½‘ç»œé—®é¢˜ï¼Œæ›´åŠ ç¨³å®šçš„æ„å»ºè¿‡ç¨‹
# ==========================================

FROM ubuntu:24.04

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DEBIAN_FRONTEND=noninteractive
ENV NODE_ENV=production
ENV SERVER_HOST=0.0.0.0
ENV SERVER_PORT=3001
ENV DATABASE_PATH=/app/data/domains.db
ENV BACKUP_DIR=/app/data/backups
ENV LC_ALL=C.UTF-8
ENV LANG=C.UTF-8

# è®¾ç½®æ—¶åŒº
RUN ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo Asia/Shanghai > /etc/timezone

# æ›´æ–°ç³»ç»ŸåŒ…å¹¶å®‰è£…åŸºç¡€ä¾èµ– - ä½¿ç”¨é‡è¯•æœºåˆ¶
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get update --fix-missing || apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        wget \
        ca-certificates \
        gnupg \
        lsb-release \
        sqlite3 \
        build-essential \
        && rm -rf /var/lib/apt/lists/*

# å®‰è£…Node.js 22 - ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶é¿å…ç½‘ç»œé—®é¢˜
RUN ARCH="$(dpkg --print-architecture)" && \
    case "$ARCH" in \
        amd64) NODE_ARCH="x64" ;; \
        arm64) NODE_ARCH="arm64" ;; \
        *) echo "Unsupported architecture: $ARCH" && exit 1 ;; \
    esac && \
    NODE_VERSION="22.17.1" && \
    curl -fsSLO "https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-$NODE_ARCH.tar.xz" && \
    tar -xJf "node-v$NODE_VERSION-linux-$NODE_ARCH.tar.xz" -C /usr/local --strip-components=1 && \
    rm "node-v$NODE_VERSION-linux-$NODE_ARCH.tar.xz" && \
    ln -s /usr/local/bin/node /usr/bin/node && \
    ln -s /usr/local/bin/npm /usr/bin/npm

# éªŒè¯Node.jsç‰ˆæœ¬
RUN node --version && npm --version

# åˆ›å»ºåº”ç”¨ç”¨æˆ·å’Œç»„
RUN groupadd -g 1001 dommate && \
    useradd -r -u 1001 -g dommate dommate

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºå¿…è¦ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /app/data /app/logs /app/backups /app/temp/exports && \
    chown -R dommate:dommate /app && \
    chmod -R 755 /app

# å¤åˆ¶åº”ç”¨æ–‡ä»¶ï¼ˆåŒ…æ‹¬node_modulesï¼‰
COPY --chown=dommate:dommate package*.json ./
COPY --chown=dommate:dommate node_modules/ ./node_modules/
COPY --chown=dommate:dommate server/ ./server/
COPY --chown=dommate:dommate dist/ ./dist/
COPY --chown=dommate:dommate public/ ./public/
COPY --chown=dommate:dommate domain-config.js ./
COPY --chown=dommate:dommate env.example ./.env.example

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN cat > /app/entrypoint.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ DomMate å®¹å™¨å¯åŠ¨ä¸­ (Ubuntu 24.04 + Node.js 22)..."
echo "ğŸ“Š Node.js ç‰ˆæœ¬: $(node --version)"
echo "ğŸ“Š NPM ç‰ˆæœ¬: $(npm --version)"
echo "ğŸ“Š ç³»ç»Ÿæ¶æ„: $(uname -m)"
echo "ğŸ“Š è¿è¡Œç”¨æˆ·: $(whoami)"
echo "ğŸŒ ç³»ç»Ÿç‰ˆæœ¬: $(lsb_release -d 2>/dev/null | cut -f2 || echo 'Ubuntu 24.04')"

# ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
mkdir -p /app/data/backups

# æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
echo "âš™ï¸ ç¯å¢ƒé…ç½®:"
echo "  â€¢ æ•°æ®åº“è·¯å¾„: ${DATABASE_PATH}"
echo "  â€¢ å¤‡ä»½ç›®å½•: ${BACKUP_DIR}"
echo "  â€¢ æœåŠ¡ç«¯å£: ${SERVER_PORT}"
echo "  â€¢ è¯­è¨€ç¯å¢ƒ: ${LANG}"

# æ£€æŸ¥å‰ç«¯æ„å»ºäº§ç‰©
if [ -f "/app/dist/index.html" ]; then
    echo "âœ… å‰ç«¯æ„å»ºäº§ç‰©å­˜åœ¨"
    echo "ğŸ“Š å‰ç«¯æ–‡ä»¶æ•°é‡: $(ls /app/dist/ | wc -l)"
else
    echo "âŒ å‰ç«¯æ„å»ºäº§ç‰©ç¼ºå¤±"
fi

# æ£€æŸ¥node_modules
if [ -d "/app/node_modules" ]; then
    echo "âœ… Node.jsä¾èµ–å­˜åœ¨"
    echo "ğŸ“¦ ä¾èµ–åŒ…æ•°é‡: $(ls /app/node_modules/ | wc -l)"
else
    echo "âŒ Node.jsä¾èµ–ç¼ºå¤±"
fi

# æ£€æŸ¥å…³é”®ä¾èµ–
if [ -d "/app/node_modules/fontkit" ]; then
    echo "âœ… fontkitä¾èµ–å­˜åœ¨"
else
    echo "âš ï¸  fontkitä¾èµ–ç¼ºå¤±"
fi

if [ -d "/app/node_modules/pdfkit" ]; then
    echo "âœ… pdfkitä¾èµ–å­˜åœ¨"
else
    echo "âš ï¸  pdfkitä¾èµ–ç¼ºå¤±"
fi

echo "ğŸ¯ å¯åŠ¨DomMateåº”ç”¨..."
exec "$@"
EOF

# è®¾ç½®æƒé™
RUN chmod +x /app/entrypoint.sh && \
    chown dommate:dommate /app/entrypoint.sh && \
    chown -R dommate:dommate /app

# åˆ‡æ¢ç”¨æˆ·
USER dommate

# æš´éœ²ç«¯å£
EXPOSE 3001

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:${SERVER_PORT}/health || exit 1

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["/app/entrypoint.sh"]
CMD ["node", "server/index.js"] 