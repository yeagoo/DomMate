# ğŸ³ DomMate CI/CD Dockerfile - Simplified Version
# Ubuntu 24.04 + Node.js 22 with robust build strategy

FROM ubuntu:24.04

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV LC_ALL=C.UTF-8
ENV LANG=C.UTF-8
ENV NODE_ENV=production
ENV TZ=Asia/Shanghai

# è®¾ç½®æ—¶åŒº
RUN ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo Asia/Shanghai > /etc/timezone

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get update --fix-missing && \
    apt-get install -y --no-install-recommends \
        curl \
        wget \
        ca-certificates \
        gnupg \
        lsb-release \
        sqlite3 \
        build-essential \
        python3 \
        locales \
        locales-all \
        && rm -rf /var/lib/apt/lists/*

# è®¾ç½®locale
RUN locale-gen en_US.UTF-8 zh_CN.UTF-8 && \
    update-locale LANG=en_US.UTF-8

# å®‰è£…Node.js 22.17.1
RUN ARCH="$(dpkg --print-architecture)" && \
    case "$ARCH" in \
        amd64) NODE_ARCH="x64" ;; \
        arm64) NODE_ARCH="arm64" ;; \
        *) echo "Unsupported architecture: $ARCH" && exit 1 ;; \
    esac && \
    NODE_VERSION="22.17.1" && \
    curl -fsSLO "https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-$NODE_ARCH.tar.xz" && \
    tar -xJf "node-v$NODE_VERSION-linux-$NODE_ARCH.tar.xz" -C /usr/local --strip-components=1 && \
    rm "node-v$NODE_VERSION-linux-$NODE_ARCH.tar.xz" && \
    ln -s /usr/local/bin/node /usr/bin/node && \
    ln -s /usr/local/bin/npm /usr/bin/npm

# éªŒè¯å®‰è£…
RUN node --version && npm --version

# åˆ›å»ºç”¨æˆ·
RUN groupadd -g 1001 dommate && \
    useradd -r -u 1001 -g dommate dommate

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºç›®å½•
RUN mkdir -p /app/data /app/logs /app/backups /app/temp/exports && \
    chown -R dommate:dommate /app && \
    chmod -R 755 /app

# å¤åˆ¶packageæ–‡ä»¶
COPY --chown=dommate:dommate package*.json ./

# é…ç½®npm
RUN npm config set registry https://registry.npmjs.org/ && \
    npm config set fetch-retries 5 && \
    npm config set fetch-retry-factor 10 && \
    npm config set fetch-retry-mintimeout 10000 && \
    npm config set fetch-retry-maxtimeout 60000

# æ¸…ç†ç¼“å­˜
RUN npm cache clean --force

# å®‰è£…æ‰€æœ‰ä¾èµ–
RUN echo "ğŸ”§ Installing all dependencies..." && \
    npm install --legacy-peer-deps --no-audit --no-fund

# å¤åˆ¶æºä»£ç 
COPY --chown=dommate:dommate . .

# æ„å»ºå‰ç«¯ - ç¬¬ä¸€æ¬¡å°è¯•
RUN echo "ğŸ—ï¸ Attempt 1: Standard frontend build..." && \
    npm run build && echo "âœ… Standard build succeeded" || echo "âŒ Standard build failed"

# æ„å»ºå‰ç«¯ - ç¬¬äºŒæ¬¡å°è¯• (å¦‚æœç¬¬ä¸€æ¬¡å¤±è´¥)
RUN if [ ! -d "dist" ]; then \
        echo "ğŸ”§ Attempt 2: Rollup fix..." && \
        rm -rf node_modules/@rollup/ node_modules/rollup && \
        npm install @rollup/rollup-linux-x64-gnu --optional --legacy-peer-deps && \
        npm run build && echo "âœ… Rollup fix succeeded" || echo "âŒ Rollup fix failed"; \
    fi

# æ„å»ºå‰ç«¯ - ç¬¬ä¸‰æ¬¡å°è¯• (å¦‚æœå‰ä¸¤æ¬¡éƒ½å¤±è´¥)
RUN if [ ! -d "dist" ]; then \
        echo "ğŸ”„ Attempt 3: Complete reinstall..." && \
        rm -rf node_modules package-lock.json && \
        npm cache clean --force && \
        npm install --legacy-peer-deps --no-audit --no-fund && \
        npm install @rollup/rollup-linux-x64-gnu --save-optional --legacy-peer-deps && \
        npm run build && echo "âœ… Full reinstall succeeded" || echo "âŒ Full reinstall failed"; \
    fi

# æ„å»ºå‰ç«¯ - æœ€åå°è¯• (ç®€åŒ–é…ç½®)
RUN if [ ! -d "dist" ]; then \
        echo "ğŸ”§ Attempt 4: Simplified config..." && \
        cp astro.config.mjs astro.config.mjs.backup && \
        echo 'import { defineConfig } from "astro/config"; import react from "@astrojs/react"; export default defineConfig({ integrations: [react()], output: "static", build: { assets: "assets" } });' > astro.config.mjs && \
        npm run build && \
        mv astro.config.mjs.backup astro.config.mjs && \
        echo "âœ… Simplified config succeeded" || \
        (echo "ğŸ’¥ All build attempts failed" && exit 1); \
    fi

# éªŒè¯æ„å»ºç»“æœ
RUN if [ -d "dist" ]; then \
        echo "âœ… Build verification passed" && \
        ls -la dist/ && \
        echo "ğŸ“Š Files: HTML=$(find dist -name "*.html" | wc -l) JS=$(find dist -name "*.js" | wc -l) CSS=$(find dist -name "*.css" | wc -l)"; \
    else \
        echo "âŒ Build verification failed - no dist directory" && \
        exit 1; \
    fi

# æ¸…ç†å¼€å‘ä¾èµ–
RUN npm prune --production && \
    npm cache clean --force && \
    rm -rf /tmp/* /var/tmp/* ~/.npm ~/.cache

# åˆ‡æ¢ç”¨æˆ·
USER dommate

# æš´éœ²ç«¯å£
EXPOSE 3001

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3001/health || exit 1

# å¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\nset -e\necho "ğŸš€ DomMate CI/CD Container Starting..."\necho "- Node.js: $(node --version)"\necho "- Architecture: $(uname -m)"\nmkdir -p /app/data /app/logs /app/backups /app/temp/exports\necho "ğŸ¯ Starting DomMate server..."\nexec node server/index.js' > /app/entrypoint.sh

# è®¾ç½®æƒé™
USER root
RUN chmod +x /app/entrypoint.sh && chown dommate:dommate /app/entrypoint.sh
USER dommate

# å…¥å£
ENTRYPOINT ["/app/entrypoint.sh"] 