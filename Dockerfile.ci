# ğŸ³ DomMate CI/CD Dockerfile - Ubuntu 24.04 + Node.js 22
# ä¸“ä¸ºGitHub Actionsä¼˜åŒ–ï¼Œåœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œå®Œæ•´æ„å»ºæµç¨‹

FROM ubuntu:24.04

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV LC_ALL=C.UTF-8
ENV LANG=C.UTF-8
ENV NODE_ENV=production
ENV TZ=Asia/Shanghai

# è®¾ç½®æ—¶åŒº
RUN ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo Asia/Shanghai > /etc/timezone

# å®‰è£…ç³»ç»Ÿä¾èµ–å’ŒNode.js
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get update --fix-missing || apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        wget \
        ca-certificates \
        gnupg \
        lsb-release \
        sqlite3 \
        build-essential \
        python3 \
        locales \
        locales-all \
        && rm -rf /var/lib/apt/lists/*

# ç”Ÿæˆlocale
RUN locale-gen en_US.UTF-8 zh_CN.UTF-8 && \
    update-locale LANG=en_US.UTF-8

# å®‰è£…Node.js 22.17.1 (æ¶æ„è‡ªé€‚åº”)
RUN ARCH="$(dpkg --print-architecture)" && \
    case "$ARCH" in \
        amd64) NODE_ARCH="x64" ;; \
        arm64) NODE_ARCH="arm64" ;; \
        *) echo "Unsupported architecture: $ARCH" && exit 1 ;; \
    esac && \
    NODE_VERSION="22.17.1" && \
    curl -fsSLO "https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-$NODE_ARCH.tar.xz" && \
    tar -xJf "node-v$NODE_VERSION-linux-$NODE_ARCH.tar.xz" -C /usr/local --strip-components=1 && \
    rm "node-v$NODE_VERSION-linux-$NODE_ARCH.tar.xz" && \
    ln -s /usr/local/bin/node /usr/bin/node && \
    ln -s /usr/local/bin/npm /usr/bin/npm

# éªŒè¯Node.jså’Œnpmå®‰è£…
RUN node --version && npm --version

# åˆ›å»ºç”¨æˆ·
RUN groupadd -g 1001 dommate && \
    useradd -r -u 1001 -g dommate dommate

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºåº”ç”¨ç›®å½•
RUN mkdir -p /app/data /app/logs /app/backups /app/temp/exports && \
    chown -R dommate:dommate /app && \
    chmod -R 755 /app

# å¤åˆ¶packageæ–‡ä»¶
COPY --chown=dommate:dommate package*.json ./

# ============================================
# æ„å»ºé˜¶æ®µï¼šåœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œnpm installå’Œbuild
# ============================================

# è®¾ç½®npmé…ç½®ï¼ˆä¼˜åŒ–ä¸‹è½½é€Ÿåº¦å’Œç¨³å®šæ€§ï¼‰
RUN npm config set registry https://registry.npmjs.org/ && \
    npm config set fetch-retries 5 && \
    npm config set fetch-retry-factor 10 && \
    npm config set fetch-retry-mintimeout 10000 && \
    npm config set fetch-retry-maxtimeout 60000

# æ¸…ç†npmç¼“å­˜
RUN npm cache clean --force

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼Œç”¨äºå‰ç«¯æ„å»ºï¼‰
RUN echo "ğŸ”§ Installing all dependencies for CI/CD build..." && \
    npm install --legacy-peer-deps --no-audit --no-fund || \
    (echo "npm install failed, trying with cache clean..." && \
     npm cache clean --force && \
     npm install --legacy-peer-deps --no-audit --no-fund)

# å¤åˆ¶æºä»£ç 
COPY --chown=dommate:dommate . .

# æ‰§è¡Œå‰ç«¯æ„å»ºï¼ˆä½¿ç”¨å¼ºåŒ–çš„æ„å»ºç­–ç•¥ï¼‰
RUN echo "ğŸ—ï¸ Building frontend with enhanced error handling..." && \
    echo "ğŸ“Š Build Environment Info:" && \
    echo "- System: $(uname -a)" && \
    echo "- Node.js: $(node --version)" && \
    echo "- npm: $(npm --version)" && \
    echo "- Architecture: $(dpkg --print-architecture)" && \
    echo "- Package count: $(ls node_modules | wc -l)" && \
    echo "- TailwindCSS: $([ -d "node_modules/tailwindcss" ] && echo "âœ… Found" || echo "âŒ Missing")" && \
    echo "- Rollup: $([ -d "node_modules/rollup" ] && echo "âœ… Found" || echo "âŒ Missing")" && \
    echo "" && \
    (echo "ğŸ” Attempt 1: Standard build" && \
     npm run build && echo "âœ… Standard build succeeded") || \
    (echo "ğŸ”§ Attempt 2: Rollup dependency fix" && \
     echo "Cleaning rollup modules..." && \
     rm -rf node_modules/@rollup/ node_modules/rollup && \
     echo "Installing glibc rollup..." && \
     npm install @rollup/rollup-linux-x64-gnu --optional --legacy-peer-deps && \
     echo "Verifying rollup installation..." && \
     ls -la node_modules/@rollup/ && \
     npm run build && echo "âœ… Rollup fix build succeeded") || \
    (echo "ğŸ”„ Attempt 3: Complete dependency reinstall" && \
     echo "Removing all node modules..." && \
     rm -rf node_modules package-lock.json && \
     echo "Cleaning npm cache..." && \
     npm cache clean --force && \
     echo "Reinstalling all dependencies..." && \
     npm install --legacy-peer-deps --no-audit --no-fund && \
     echo "Manually installing rollup for current architecture..." && \
     npm install @rollup/rollup-linux-x64-gnu --save-optional --legacy-peer-deps && \
     echo "Verifying critical dependencies:" && \
     echo "- TailwindCSS: $([ -d "node_modules/tailwindcss" ] && echo "âœ… Found" || echo "âŒ Missing")" && \
     echo "- Rollup: $([ -d "node_modules/rollup" ] && echo "âœ… Found" || echo "âŒ Missing")" && \
     echo "- @rollup modules: $(ls node_modules/@rollup/ | head -5)" && \
     npm run build && echo "âœ… Full reinstall build succeeded") || \
    (echo "ğŸ”§ Attempt 4: Simplified Astro configuration" && \
     echo "Creating simplified astro config..." && \
     cp astro.config.mjs astro.config.mjs.backup && \
     cat > astro.config.mjs << 'EOF'
import { defineConfig } from 'astro/config';
import react from '@astrojs/react';

export default defineConfig({
  integrations: [react()],
  output: 'static',
  build: {
    assets: 'assets'
  }
});
EOF
     echo "Building with simplified config..." && \
     npm run build && \
     echo "âœ… Simplified config build succeeded" && \
     mv astro.config.mjs.backup astro.config.mjs) || \
    (echo "ğŸ’¥ All build attempts failed - Running diagnostics" && \
     echo "ğŸ“‹ Diagnostic Information:" && \
     echo "- Working directory: $(pwd)" && \
     echo "- Node modules exists: $([ -d "node_modules" ] && echo "âœ… Yes" || echo "âŒ No")" && \
     echo "- Package.json exists: $([ -f "package.json" ] && echo "âœ… Yes" || echo "âŒ No")" && \
     echo "- Source files exist: $([ -d "src" ] && echo "âœ… Yes" || echo "âŒ No")" && \
     echo "- Astro config exists: $([ -f "astro.config.mjs" ] && echo "âœ… Yes" || echo "âŒ No")" && \
     echo "" && \
     echo "ğŸ” Critical Dependencies Check:" && \
     echo "- astro: $(npm list astro --depth=0 2>/dev/null | grep astro || echo "âŒ Missing")" && \
     echo "- @astrojs/react: $(npm list @astrojs/react --depth=0 2>/dev/null | grep @astrojs/react || echo "âŒ Missing")" && \
     echo "- @astrojs/tailwind: $(npm list @astrojs/tailwind --depth=0 2>/dev/null | grep @astrojs/tailwind || echo "âŒ Missing")" && \
     echo "- tailwindcss: $(npm list tailwindcss --depth=0 2>/dev/null | grep tailwindcss || echo "âŒ Missing")" && \
     echo "- rollup: $(npm list rollup --depth=0 2>/dev/null | grep rollup || echo "âŒ Missing")" && \
     echo "" && \
     echo "ğŸ—‚ï¸ Node modules structure:" && \
     ls -la node_modules/ | head -20 && \
     echo "" && \
     echo "ğŸ“¦ @rollup modules:" && \
     ls -la node_modules/@rollup/ 2>/dev/null || echo "No @rollup directory found" && \
     exit 1)

# éªŒè¯æ„å»ºäº§ç‰©
RUN echo "ğŸ“¦ Verifying build artifacts..." && \
    if [ -d "dist" ]; then \
        echo "âœ… dist directory exists" && \
        echo "ğŸ“ dist contents:" && \
        ls -la dist/ && \
        echo "ğŸ“Š Build statistics:" && \
        echo "- HTML files: $(find dist -name "*.html" | wc -l)" && \
        echo "- JS files: $(find dist -name "*.js" | wc -l)" && \
        echo "- CSS files: $(find dist -name "*.css" | wc -l)" && \
        echo "- Total files: $(find dist -type f | wc -l)" && \
        echo "âœ… Build verification complete"; \
    else \
        echo "âŒ dist directory not found" && \
        exit 1; \
    fi

# æ¸…ç†å¼€å‘ä¾èµ–å’Œæ„å»ºç¼“å­˜ï¼ˆä¿ç•™è¿è¡Œæ—¶éœ€è¦çš„ï¼‰
RUN echo "ğŸ§¹ Cleaning up build artifacts..." && \
    npm prune --production && \
    npm cache clean --force && \
    rm -rf /tmp/* /var/tmp/* ~/.npm ~/.cache

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER dommate

# è®¾ç½®å¯åŠ¨ç›®å½•æƒé™
RUN ls -la /app && \
    echo "Final directory structure ready"

# æš´éœ²ç«¯å£
EXPOSE 3001

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3001/health || exit 1

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash' > /app/entrypoint.sh && \
    echo 'set -e' >> /app/entrypoint.sh && \
    echo '' >> /app/entrypoint.sh && \
    echo 'echo "ğŸš€ DomMate CI/CD Container Starting..."' >> /app/entrypoint.sh && \
    echo 'echo "=================================="' >> /app/entrypoint.sh && \
    echo 'echo "ğŸ“Š Container Info:"' >> /app/entrypoint.sh && \
    echo 'echo "- OS: $(uname -s)"' >> /app/entrypoint.sh && \
    echo 'echo "- Architecture: $(uname -m)"' >> /app/entrypoint.sh && \
    echo 'echo "- Node.js: $(node --version)"' >> /app/entrypoint.sh && \
    echo 'echo "- Timezone: $(date +%Z)"' >> /app/entrypoint.sh && \
    echo 'echo "- User: $(whoami)"' >> /app/entrypoint.sh && \
    echo 'echo "=================================="' >> /app/entrypoint.sh && \
    echo '' >> /app/entrypoint.sh && \
    echo '# ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨' >> /app/entrypoint.sh && \
    echo 'mkdir -p /app/data /app/logs /app/backups /app/temp/exports' >> /app/entrypoint.sh && \
    echo '' >> /app/entrypoint.sh && \
    echo '# å¯åŠ¨åº”ç”¨' >> /app/entrypoint.sh && \
    echo 'echo "ğŸ¯ Starting DomMate server..."' >> /app/entrypoint.sh && \
    echo 'exec node server/index.js' >> /app/entrypoint.sh

# è®¾ç½®å¯åŠ¨è„šæœ¬æƒé™
USER root
RUN chmod +x /app/entrypoint.sh && chown dommate:dommate /app/entrypoint.sh
USER dommate

# è®¾ç½®å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["/app/entrypoint.sh"] 