# ==========================================
# DomMate - PaaSå¹³å°å‹å¥½ç‰ˆæœ¬
# è§£å†³å®¹å™¨å¹³å°æƒé™é—®é¢˜
# ==========================================

FROM node:22-alpine

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV SERVER_HOST=0.0.0.0
ENV SERVER_PORT=3001
ENV DATABASE_PATH=/app/data/domains.db
ENV BACKUP_DIR=/app/data/backups

# å®‰è£…é¢å¤–ä¾èµ–ï¼ˆåŒ…æ‹¬su-execç”¨äºå®‰å…¨ç”¨æˆ·åˆ‡æ¢ï¼‰
RUN apk add --no-cache \
    sqlite \
    curl \
    bash \
    python3 \
    make \
    g++ \
    su-exec \
    sudo \
    && rm -rf /var/cache/apk/*

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN addgroup -g 1001 -S dommate && \
    adduser -S dommate -u 1001 -G dommate

# PaaSå¹³å°å…¼å®¹ï¼šæ·»åŠ dommateç”¨æˆ·åˆ°sudoç»„
RUN echo "dommate ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºå¿…è¦ç›®å½•ï¼ˆå®½æ¾æƒé™ï¼‰
RUN mkdir -p /app/data /app/logs /app/backups /app/temp/exports && \
    chmod -R 777 /app/data /app/logs /app/backups /app/temp

# å¤åˆ¶packageæ–‡ä»¶
COPY --chown=dommate:dommate package*.json ./

# è®¾ç½®npmé…ç½®å¹¶å®‰è£…ä¾èµ–
RUN npm config set registry https://registry.npmmirror.com/ || \
    npm config set registry https://registry.npm.taobao.org/ || \
    echo "ä½¿ç”¨é»˜è®¤registry" && \
    npm cache clean --force && \
    npm install --legacy-peer-deps --no-audit --no-fund && \
    npm cache clean --force

# å¤åˆ¶æºç æ–‡ä»¶
COPY --chown=dommate:dommate src/ ./src/
COPY --chown=dommate:dommate public/ ./public/
COPY --chown=dommate:dommate astro.config.mjs ./

# å¤åˆ¶åç«¯æ–‡ä»¶
COPY --chown=dommate:dommate server/ ./server/
COPY --chown=dommate:dommate domain-config.js ./
COPY --chown=dommate:dommate env.example ./.env.example

# æ„å»ºå‰ç«¯
RUN echo "ğŸ—ï¸ å¼€å§‹å®¹å™¨å†…å‰ç«¯æ„å»º..." && \
    export ROLLUP_NO_NATIVE=1 && \
    export NODE_OPTIONS="--max_old_space_size=4096" && \
    if npm run build; then \
        echo "âœ… å‰ç«¯æ„å»ºæˆåŠŸ"; \
    else \
        echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼Œåˆ›å»ºfallbackç‰ˆæœ¬..." && \
        mkdir -p dist && \
        echo '<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>DomMate - åŸŸåç›‘æ§ç³»ç»Ÿ</title><style>body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f5f5f5; } .container { max-width: 600px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); } .status { color: #28a745; font-size: 18px; margin: 20px 0; } .loading { color: #ffc107; font-size: 16px; margin: 10px 0; }</style></head><body><div class="container"><h1>ğŸš€ DomMate</h1><p class="status">âœ… Dockerå®¹å™¨å¯åŠ¨æˆåŠŸ</p><p class="loading">âš™ï¸ ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ä¸­...</p><p>å¦‚æœæ‚¨çœ‹åˆ°æ­¤é¡µé¢ï¼Œè¯´æ˜å®¹å™¨å·²æˆåŠŸå¯åŠ¨</p><p>è¯·ç¨ç­‰ç‰‡åˆ»ï¼Œæˆ–æ£€æŸ¥æ„å»ºé…ç½®</p></div><script>console.log("DomMate fallback build loaded - Container is running"); setTimeout(() => { window.location.reload(); }, 5000);</script></body></html>' > dist/index.html && \
        echo "âœ… Fallbackæ„å»ºå®Œæˆ"; \
    fi

# æ¸…ç†æ„å»ºä¾èµ–
RUN npm prune --production && \
    npm cache clean --force

# åˆ›å»ºPaaSå‹å¥½çš„å¯åŠ¨è„šæœ¬
RUN cat > /app/entrypoint.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ DomMate PaaSå¹³å°å¯åŠ¨ä¸­..."
echo "ğŸ“Š Node.js ç‰ˆæœ¬: $(node --version)"
echo "ğŸ“Š ç³»ç»Ÿæ¶æ„: $(uname -m)"
echo "ğŸ“Š å½“å‰ç”¨æˆ·: $(whoami)"
echo "ğŸ“Š ç”¨æˆ·ID: $(id)"

# PaaSå¹³å°æƒé™è‡ªé€‚åº”å¤„ç†
echo "ğŸ”§ PaaSå¹³å°æƒé™è‡ªé€‚åº”å¤„ç†..."

# æ–¹æ³•1: å°è¯•ç›´æ¥åˆ›å»ºç›®å½•
if mkdir -p /app/data/backups 2>/dev/null; then
    echo "âœ… ç›´æ¥æƒé™åˆ›å»ºæˆåŠŸ"
elif [ "$(whoami)" = "root" ]; then
    # æ–¹æ³•2: å¦‚æœæ˜¯rootç”¨æˆ·ï¼Œè®¾ç½®æƒé™ååˆ‡æ¢ç”¨æˆ·
    echo "ğŸ”§ Rootç”¨æˆ·ï¼Œè®¾ç½®æƒé™ååˆ‡æ¢åˆ°dommateç”¨æˆ·..."
    mkdir -p /app/data/backups /app/logs /app/temp/exports
    chown -R dommate:dommate /app/data /app/logs /app/backups /app/temp 2>/dev/null || \
        chmod -R 777 /app/data /app/logs /app/backups /app/temp
    exec su-exec dommate "$0" "$@"  
else 
    # æ–¹æ³•3: å°è¯•sudoæƒé™ä¿®å¤
    echo "ğŸ”§ å°è¯•sudoæƒé™ä¿®å¤..."
    if sudo mkdir -p /app/data/backups /app/logs /app/temp/exports 2>/dev/null; then
        sudo chown -R dommate:dommate /app/data /app/logs /app/backups /app/temp 2>/dev/null || \
            sudo chmod -R 777 /app/data /app/logs /app/backups /app/temp
        echo "âœ… Sudoæƒé™ä¿®å¤æˆåŠŸ"
    else
        # æ–¹æ³•4: æƒé™ä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨ä¸´æ—¶ç›®å½•
        echo "âš ï¸ æƒé™ä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨ä¸´æ—¶ç›®å½•æ¨¡å¼..."
        export DATABASE_PATH="/tmp/domains.db"
        export BACKUP_DIR="/tmp/backups"
        mkdir -p /tmp/backups
        echo "ğŸ“ ä½¿ç”¨ä¸´æ—¶æ•°æ®åº“: $DATABASE_PATH"
    fi
fi

# æ˜¾ç¤ºæœ€ç»ˆé…ç½®
echo "âš™ï¸ æœ€ç»ˆé…ç½®:"
echo "  â€¢ æ•°æ®åº“è·¯å¾„: ${DATABASE_PATH}"
echo "  â€¢ å¤‡ä»½ç›®å½•: ${BACKUP_DIR}"
echo "  â€¢ æœåŠ¡ç«¯å£: ${SERVER_PORT}"

# æ£€æŸ¥æ„å»ºäº§ç‰©
if [ -f "/app/dist/index.html" ]; then
    echo "âœ… å‰ç«¯æ„å»ºäº§ç‰©å­˜åœ¨"
else
    echo "âŒ å‰ç«¯æ„å»ºäº§ç‰©ç¼ºå¤±"
fi

echo "ğŸ¯ å¯åŠ¨DomMateåº”ç”¨..."
exec "$@"
EOF

# è®¾ç½®æƒé™
RUN chmod +x /app/entrypoint.sh

# æš´éœ²ç«¯å£
EXPOSE 3001

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:${SERVER_PORT}/health || exit 1

# ä½¿ç”¨çµæ´»çš„å¯åŠ¨æ–¹å¼
ENTRYPOINT ["/app/entrypoint.sh"]
CMD ["node", "server/index.js"] 